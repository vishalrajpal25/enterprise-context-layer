name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install ruff
        run: pip install ruff
      - name: Ruff check
        run: ruff check src api mcp_server tests

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run unit and contract tests
        run: pytest tests/ -v --ignore=tests/test_e2e.py -x
        env:
          SKIP_E2E: "1"

  e2e:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Start services
        run: docker compose up -d
      - name: Wait for Postgres
        run: |
          for i in $(seq 1 30); do
            if docker compose exec -T postgres pg_isready -U ecp -d ecp_registry; then break; fi
            sleep 2
          done
      - name: Seed registry and vectors
        run: |
          PGPASSWORD=changeme psql -h localhost -p 5432 -U ecp -d ecp_registry -f scripts/schema_registry.sql || true
          PGPASSWORD=changeme psql -h localhost -p 5432 -U ecp -d ecp_registry -f scripts/seed_registry.sql || true
          PGPASSWORD=changeme psql -h localhost -p 5432 -U ecp -d ecp_vectors -f scripts/schema_vectors.sql || true
          PGPASSWORD=changeme psql -h localhost -p 5432 -U ecp -d ecp_vectors -f scripts/seed_vectors.sql || true
        env:
          PGPASSWORD: changeme
      - name: Start API
        run: uvicorn api.main:app --host 0.0.0.0 --port 8000 &
      - name: Wait for API
        run: |
          for i in $(seq 1 30); do
            if curl -s http://localhost:8000/api/v1/health; then break; fi
            sleep 2
          done
      - name: Run E2E tests
        run: pytest tests/test_e2e.py -v
        env:
          SKIP_E2E: "0"
          ECP_E2E_URL: "http://localhost:8000"
